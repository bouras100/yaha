<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dino Devil — النسخة النهائية مع صعوبة، سبرايت، وشاشات</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  :root{ --bg:#111; --panel: rgba(0,0,0,0.5); --accent:#e74c3c; --text:#fff; }
  *{box-sizing:border-box;font-family:'Cairo',sans-serif}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);display:flex;align-items:center;justify-content:center}
  .container{width:980px;max-width:96vw;padding:14px;text-align:center;position:relative}
  .hud{display:flex;gap:12px;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap}
  .تعليمات{background:var(--panel);padding:8px 12px;border-radius:8px}
  .نقاط{font-size:20px;background:linear-gradient(90deg,#222,#333);padding:8px 12px;border-radius:8px}
  canvas{display:block;margin:6px auto;border-radius:8px;background:#222;box-shadow:0 6px 24px rgba(0,0,0,0.6)}
  #btn-restart,#btn-space,#btn-music,#btn-share{display:inline-block;margin-top:8px;padding:10px 14px;border:none;border-radius:8px;cursor:pointer}
  .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff}
  .btn.space{background:#3498db;color:#fff}
  .center-screen{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);z-index:40}
  .start-screen, .end-screen{background:rgba(0,0,0,0.8);padding:18px 22px;border-radius:12px;min-width:320px}
  .message-center{position:absolute; left:50%; top:40%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.7); color:#fff; padding:14px 22px; border-radius:10px; font-weight:700; font-size:20px; pointer-events:none; opacity:0; transition: opacity 300ms ease, transform 300ms ease; z-index:20;}
  .message-center.show{ opacity:1; transform:translate(-50%,-46%); }
  .controls-bottom{display:flex; gap:10px; align-items:center; justify-content:center; margin-top:8px}
  .difficulty {display:flex; gap:8px; align-items:center}
  .small{font-size:13px;color:#ccc}
  .slider{width:160px}
  @media (max-width:720px){ .slider{width:120px} .start-screen,.end-screen{min-width:260px} }
</style>
</head>
<body>
  <div class="container">
    <div class="hud">
      <div style="display:flex;gap:10px;align-items:center">
        <div class="تعليمات" id="تعليمات">🔥 تحدى الشيطان! اضغط المسافة للقفز — تجنب الفخاخ! 🔥</div>
        <div class="نقاط" id="score">النقاط: 0</div>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <div class="small" id="best">الأفضل: 0</div>
        <button id="btn-music" class="btn">إيقاف/تشغيل الموسيقى</button>
        <div class="small">جاذبية</div>
        <input id="slider-gravity" class="slider" type="range" min="0.2" max="2.0" step="0.05" value="0.6">
        <div class="small" id="gravity-value">0.60</div>
        <div class="small">قفز</div>
        <input id="slider-jump" class="slider" type="range" min="6" max="20" step="1" value="12">
        <div class="small" id="jump-value">12</div>
        <button id="btn-space" class="btn space">تفعيل وضع الفضاء</button>
      </div>
    </div>

    <div style="position:relative">
      <div id="message" class="message-center">مستوى جديد!</div>
      <canvas id="game" width="920" height="360"></canvas>
    </div>

    <div class="controls-bottom">
      <div class="difficulty">
        <label class="small">الصعوبة:</label>
        <button id="diff-easy" class="btn">سهل</button>
        <button id="diff-normal" class="btn primary">عادي</button>
        <button id="diff-hard" class="btn">صعب</button>
      </div>
      <button id="btn-restart" class="btn primary">إعادة اللعبة</button>
      <div style="color:#aaa;font-size:13px">المستوى: <span id="level">1</span></div>
      <button id="btn-share" class="btn">مشاركة النتيجة</button>
    </div>
  </div>

  <!-- شاشة البداية -->
  <div id="startScreen" class="center-screen start-screen" style="z-index:50">
    <h2>🦖 Dino Devil</h2>
    <p>اضغط 'Start' للبدء. تحكّم في الجاذبية والقفز، واختر الصعوبة.</p>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:10px">
      <button id="startBtn" class="btn primary">Start</button>
      <button id="startDemo" class="btn">Start (Demo)</button>
    </div>
  </div>

  <!-- شاشة النهاية -->
  <div id="endScreen" class="center-screen end-screen" style="display:none;z-index:60">
    <h3>انتهت اللعبة</h3>
    <p id="endScore">نقاطك: 0</p>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
      <button id="restartFromEnd" class="btn primary">إعادة</button>
      <button id="shareFromEnd" class="btn">مشاركة</button>
    </div>
  </div>

<script>
/* ---------- إعداد المتغيرات ---------- */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('score');
const bestEl = document.getElementById('best');
const levelEl = document.getElementById('level');
const messageEl = document.getElementById('message');

const sliderGravity = document.getElementById('slider-gravity');
const gravityValueEl = document.getElementById('gravity-value');
const sliderJump = document.getElementById('slider-jump');
const jumpValueEl = document.getElementById('jump-value');
const btnSpace = document.getElementById('btn-space');
const btnRestart = document.getElementById('btn-restart');
const btnMusic = document.getElementById('btn-music');
const btnShare = document.getElementById('btn-share');

const diffEasy = document.getElementById('diff-easy');
const diffNormal = document.getElementById('diff-normal');
const diffHard = document.getElementById('diff-hard');

const startScreen = document.getElementById('startScreen');
const startBtn = document.getElementById('startBtn');
const startDemo = document.getElementById('startDemo');

const endScreen = document.getElementById('endScreen');
const endScore = document.getElementById('endScore');
const restartFromEnd = document.getElementById('restartFromEnd');
const shareFromEnd = document.getElementById('shareFromEnd');

let W = canvas.width, H = canvas.height;
const GROUND_Y = 300;
let running = false;

let player = { x:80, y: GROUND_Y - 60, w:48, h:48, vy:0, onGround:true, color:'#ff3333', wings:false };
let baseGravity = parseFloat(sliderGravity.value);
let gravity = baseGravity;
let baseJump = parseInt(sliderJump.value,10);
let jumpForce = baseJump;

let obstacles = [];
let spawnInterval = 1600;
let lastSpawn = 0;
let points = 0;
let best = parseInt(localStorage.getItem('dino_best')||'0',10) || 0;
let level = 1;
let gameOver = false;

const levelColors = ['#222','#331111','#441111','#661111','#991111','#cc0000','#330033'];
let bgColor = levelColors[0], targetBg = bgColor, bgLerpT = 0;

let audioCtx = null, musicOn = true, musicOsc = [];
function initAudio(){ if(audioCtx) return; audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
function playBeep(freq=700,time=0.09){ try{ initAudio(); const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='sine'; o.frequency.value=freq; g.gain.value=0.08; o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+time);}catch(e){}}
function startMusic(){ if(!musicOn) return; initAudio(); stopMusic(); const o=audioCtx.createOscillator(); o.type='sine'; o.frequency.value=110; const g=audioCtx.createGain(); g.gain.value=0.02; o.connect(g); g.connect(audioCtx.destination); o.start(); musicOsc.push(o); }
function stopMusic(){ musicOsc.forEach(o=>{ try{o.stop()}catch(e){} }); musicOsc=[]; }
btnMusic.addEventListener('click', ()=>{ musicOn = !musicOn; if(musicOn) startMusic(); else stopMusic(); });

gravityValueEl.textContent = baseGravity.toFixed(2);
jumpValueEl.textContent = baseJump.toString();

/* ---------- difficulty settings ---------- */
let difficulty = 'normal'; // easy, normal, hard
function applyDifficulty(diff){
  difficulty = diff;
  if(diff==='easy'){ spawnInterval = 2000; }
  else if(diff==='normal'){ spawnInterval = 1600; }
  else if(diff==='hard'){ spawnInterval = 1100; }
  // visual active button
  diffEasy.classList.toggle('primary', diff==='easy');
  diffNormal.classList.toggle('primary', diff==='normal');
  diffHard.classList.toggle('primary', diff==='hard');
}
diffEasy.addEventListener('click', ()=>applyDifficulty('easy'));
diffNormal.addEventListener('click', ()=>applyDifficulty('normal'));
diffHard.addEventListener('click', ()=>applyDifficulty('hard'));
applyDifficulty('normal');

/* ---------- sprite (SVG data URI) ---------- */
/* simple SVG dinosaur-like sprite embedded as data URL */
const dinoSVG = encodeURIComponent(`
<svg xmlns='http://www.w3.org/2000/svg' width='96' height='96' viewBox='0 0 96 96'>
  <rect rx='8' ry='8' x='8' y='28' width='56' height='40' fill='#ff3b3b'/>
  <circle cx='58' cy='36' r='5' fill='#fff'/>
  <path d='M20 28 q-6 -12 8 -18 q10 2 16 10 q10 4 12 10' fill='#ff3b3b'/>
  <rect x='58' y='60' width='10' height='6' fill='#ff3b3b' transform='rotate(20 63 63)'/>
</svg>`);
const dinoImg = new Image();
dinoImg.src = 'data:image/svg+xml;utf8,' + dinoSVG;
let spriteLoaded = false;
dinoImg.onload = ()=>{ spriteLoaded = true; };

/* ---------- drawing helpers ---------- */
function drawPlayer(){
  if(spriteLoaded){
    // draw sprite scaled to player size
    ctx.drawImage(dinoImg, player.x - 6, player.y - 6, player.w + 12, player.h + 12);
  } else {
    // fallback rectangle
    ctx.fillStyle = player.color;
    ctx.fillRect(player.x, player.y, player.w, player.h);
  }
}
function drawGround(){
  ctx.fillStyle = '#444';
  ctx.fillRect(0, GROUND_Y, W, H - GROUND_Y);
  for(let i=0;i<W;i+=40){ ctx.fillStyle='rgba(0,0,0,0.06)'; ctx.fillRect(i, GROUND_Y+18, 30, 2); }
}
function drawFlame(f){ ctx.fillStyle='orange'; ctx.beginPath(); ctx.moveTo(f.x, f.y + f.h); ctx.quadraticCurveTo(f.x + f.w/2, f.y + f.h - 50, f.x + f.w, f.y + f.h); ctx.fill(); }
function drawSpike(s){ ctx.fillStyle='#222'; ctx.fillRect(s.x+3, s.y+s.h-6, s.w, 6); ctx.fillStyle='#ffcc00'; ctx.beginPath(); ctx.moveTo(s.x,s.y+s.h); ctx.lineTo(s.x+s.w/2,s.y); ctx.lineTo(s.x+s.w,s.y+s.h); ctx.closePath(); ctx.fill(); }
function drawHole(h){ ctx.fillStyle='#111'; ctx.fillRect(h.x, GROUND_Y, h.w, H - GROUND_Y); ctx.fillStyle='rgba(0,0,0,0.35)'; ctx.fillRect(h.x+4, GROUND_Y+6, h.w-8, 6); }
function drawFireball(b){ ctx.fillStyle='#331100'; ctx.beginPath(); ctx.ellipse(b.x + b.w/2, b.y + b.h/2, b.w/2, b.h/2, 0, 0, Math.PI*2); ctx.fill(); ctx.fillStyle='orange'; ctx.beginPath(); ctx.ellipse(b.x + b.w/2, b.y + b.h/2 - 4, b.w/3, b.h/3, 0, 0, Math.PI*2); ctx.fill(); }

/* ---------- collisions ---------- */
function rectsOverlap(a,b){ return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y; }

/* ---------- spawn logic (progressive by level) ---------- */
function spawnForLevel(now){
  const allowSpikes = (level >= 2);
  const allowHoles = (level >= 3);
  const allowFireballs = (level >= 4);
  const r = Math.random();
  if(allowFireballs && r < 0.18){
    obstacles.push({ type:'fireball', x: W, y: 160 + Math.random()*80, w: 34, h: 34, vy: (Math.random()*0.6+0.4), phase: Math.random()*Math.PI*2 });
  } else if(allowHoles && r < 0.35){
    const w = 90 + Math.floor(Math.random()*80);
    obstacles.push({ type:'hole', x: W, w: w });
  } else if(allowSpikes && r < 0.6){
    const count = 1 + Math.floor(Math.random()*3);
    for(let i=0;i<count;i++){ obstacles.push({ type:'spike', x: W + i*34, y: GROUND_Y - 14, w: 30, h: 14 }); }
  } else {
    obstacles.push({ type:'flame', x: W, y: GROUND_Y - 70, w: 32, h: 60 });
  }
}

/* ---------- update physics ---------- */
function update(dt, now){
  if(gameOver) return;

  // gravity applied scaled by dt for framerate independence
  player.y += player.vy;
  if(player.y + player.h < GROUND_Y){
    player.vy += gravity * (dt/16.67);
    player.onGround = false;
  } else {
    player.y = GROUND_Y - player.h;
    player.vy = 0;
    player.onGround = true;
  }

  if(now - lastSpawn > spawnInterval){
    spawnForLevel(now);
    lastSpawn = now;
  }

  for(let o of obstacles){
    if(o.type === 'flame' || o.type === 'spike' || o.type === 'hole'){ o.x -= (4 + (difficulty==='hard'?2: difficulty==='easy'?0.5:0.8) * level); }
    if(o.type === 'fireball'){ o.x -= (4 + (difficulty==='hard'?2: difficulty==='easy'?0.5:0.8) * level); o.phase += o.vy * (dt/16.67); o.y += Math.sin(o.phase) * 0.9; }
  }

  obstacles = obstacles.filter(o => {
    if(o.type === 'hole') return o.x + (o.w||0) > -50;
    return o.x + (o.w||30) > -50;
  });

  points += dt * 0.02;
  scoreEl.textContent = 'النقاط: ' + Math.floor(points);

  const newLevel = Math.floor(points / 150) + 1;
  if(newLevel !== level){
    level = newLevel; onLevelUp(level);
  }
  levelEl.textContent = level;

  // collision detection
  for(let o of obstacles){
    if(o.type === 'flame' || o.type === 'spike' || o.type === 'fireball'){
      const b = { x:o.x, y:o.y || (GROUND_Y - (o.h||30)), w:o.w, h:o.h || 30 };
      if(rectsOverlap(player, b)){ hit(); return; }
    } else if(o.type === 'hole'){
      if(player.x + player.w > o.x && player.x < o.x + o.w){
        if(player.y + player.h >= GROUND_Y - 0.5){ hit(); return; }
      }
    }
  }

  if(Math.floor(points) > best){ best = Math.floor(points); bestEl.textContent = 'الأفضل: ' + best; localStorage.setItem('dino_best', best); }
}

/* ---------- level up ---------- */
function onLevelUp(lv){
  spawnInterval = Math.max(700, spawnInterval - 120);
  targetBg = levelColors[Math.min(levelColors.length-1, lv-1)];
  bgLerpT = 0;
  showMessage(`🎯 مستوى ${lv}! ${levelHint(lv)}`, 1800);
  playBeep(880,0.08); setTimeout(()=>playBeep(1180,0.08),90);
  if(lv >= 3) player.wings = true;
  if(lv >= 5) player.color = '#a30000';
  if(lv >= 8) player.color = '#440000';
}
function levelHint(lv){
  if(lv === 2) return 'احذر الأشواك!';
  if(lv === 3) return 'ثقوب في الأرض!';
  if(lv >= 4) return 'كرات نار متحركة!';
  return 'استمر!';
}

/* ---------- hit / game over ---------- */
function hit(){
  if(gameOver) return;
  playBeep(160,0.25);
  document.body.style.transition = 'transform 0.07s';
  document.body.style.transform = 'translateX(6px)';
  setTimeout(()=> document.body.style.transform = 'translateX(-6px)',70);
  setTimeout(()=> document.body.style.transform = 'translateX(0)',140);
  gameOver = true;
  btnRestart.style.display = 'inline-block';
  endScore.textContent = 'نقاطك: ' + Math.floor(points);
  endScreen.style.display = 'block';
}

/* ---------- messages ---------- */
let msgTimeout = null;
function showMessage(txt, ms=1500){
  if(msgTimeout) clearTimeout(msgTimeout);
  messageEl.textContent = txt;
  messageEl.classList.add('show');
  playBeep(1000,0.12);
  msgTimeout = setTimeout(()=>{ messageEl.classList.remove('show'); msgTimeout = null; }, ms);
}

/* ---------- render ---------- */
function lerp(a,b,t){ return a + (b-a)*t; }
function hexToRgb(hex){ hex = hex.replace('#',''); if(hex.length===3) hex = hex.split('').map(ch=>ch+ch).join(''); const bigint = parseInt(hex,16); return { r:(bigint>>16)&255, g:(bigint>>8)&255, b:bigint&255 }; }
function render(dt){
  if(bgLerpT < 1){ bgLerpT = Math.min(1, bgLerpT + 0.012); const c1 = hexToRgb(bgColor); const c2 = hexToRgb(targetBg); const r = Math.round(lerp(c1.r,c2.r,bgLerpT)); const g = Math.round(lerp(c1.g,c2.g,bgLerpT)); const b = Math.round(lerp(c1.b,c2.b,bgLerpT)); canvas.style.background = `rgb(${r},${g},${b})`; if(bgLerpT===1) bgColor = targetBg; }
  ctx.clearRect(0,0,W,H);
  drawGround(); drawPlayer();
  // draw holes first
  for(let o of obstacles){ if(o.type==='hole') drawHole(o); }
  for(let o of obstacles){ if(o.type==='spike') drawSpike(o); else if(o.type==='flame') drawFlame(o); else if(o.type==='fireball') drawFireball(o); }
}

/* ---------- game loop (single RAF) ---------- */
let lastTime = 0;
function gameLoop(ts){
  if(!running) return;
  if(!lastTime) lastTime = ts;
  const dt = ts - lastTime;
  lastTime = ts;
  const now = performance.now();
  update(dt, now);
  render(dt);
  requestAnimationFrame(gameLoop);
}

/* ---------- controls ---------- */
function jump(){
  if(gameOver) return;
  if(player.onGround){
    player.vy = -jumpForce;
    player.onGround = false;
    playBeep(440,0.06);
  }
}
document.addEventListener('keydown', (e)=>{ if(e.code==='Space'){ e.preventDefault(); jump(); }});
canvas.addEventListener('mousedown', ()=>{ jump(); });
canvas.addEventListener('touchstart', (e)=>{ e.preventDefault(); jump(); });

sliderGravity.addEventListener('input', (e)=>{
  if(btnSpace.dataset.on === 'true'){ baseGravity = parseFloat(e.target.value); gravityValueEl.textContent = baseGravity.toFixed(2); } 
  else { baseGravity = parseFloat(e.target.value); gravity = baseGravity; gravityValueEl.textContent = baseGravity.toFixed(2); }
});
sliderJump.addEventListener('input', (e)=>{ baseJump = parseInt(e.target.value,10); jumpForce = baseJump; jumpValueEl.textContent = jumpForce.toString(); });

btnSpace.addEventListener('click', ()=>{
  if(btnSpace.dataset.on === 'true'){ btnSpace.dataset.on = 'false'; btnSpace.textContent = 'تفعيل وضع الفضاء'; gravity = baseGravity; jumpForce = baseJump; gravityValueEl.textContent = gravity.toFixed(2); jumpValueEl.textContent = jumpForce.toString(); }
  else { btnSpace.dataset.on = 'true'; btnSpace.textContent = 'إيقاف وضع الفضاء'; gravity = 0.2; jumpForce = 8; gravityValueEl.textContent = gravity.toFixed(2); jumpValueEl.textContent = jumpForce.toString(); }
});

/* ---------- restart / start / share ---------- */
function resetGame(){
  player = { x:80, y: GROUND_Y - 60, w:48, h:48, vy:0, onGround:true, color:'#ff3333', wings:false };
  obstacles = []; points = 0; level = 1; gameOver = false; btnRestart.style.display='none'; endScreen.style.display='none';
  spawnInterval = (difficulty==='easy'?2000: difficulty==='hard'?1100:1600);
  lastSpawn = performance.now(); lastTime = performance.now();
  // set gravity/jump from sliders or space mode
  if(btnSpace.dataset.on === 'true'){ gravity = 0.2; jumpForce = 8; } else { baseGravity = parseFloat(sliderGravity.value); gravity = baseGravity; baseJump = parseInt(sliderJump.value,10); jumpForce = baseJump; }
  scoreEl.textContent = 'النقاط: 0'; levelEl.textContent = level; bestEl.textContent = 'الأفضل: ' + best;
}
btnRestart.addEventListener('click', resetGame);
restartFromEnd.addEventListener('click', ()=>{ resetGame(); });

startBtn.addEventListener('click', ()=>{
  startScreen.style.display = 'none';
  running = true;
  lastSpawn = performance.now(); lastTime = performance.now();
  startMusic();
  requestAnimationFrame(gameLoop);
});
startDemo.addEventListener('click', ()=>{ /* start but keep paused obstacles? just start normally */ startBtn.click(); });

function shareScore(val){
  const text = `لعبت Dino Devil وحققت ${val} نقطة! جربها الآن!`;
  if(navigator.share){
    navigator.share({ title:'Dino Devil', text: text }).catch(()=>{ copyToClipboard(text); });
  } else { copyToClipboard(text); alert('تم نسخ النتيجة إلى الحافظة'); }
}
function copyToClipboard(txt){ navigator.clipboard?.writeText(txt).catch(()=>{}); }

btnShare.addEventListener('click', ()=> shareScore(Math.floor(points)));
shareFromEnd.addEventListener('click', ()=> shareScore(Math.floor(points)));

/* ---------- start initial ---------- */
function startInitial(){
  bestEl.textContent = 'الأفضل: ' + best;
  gravity = baseGravity; jumpForce = baseJump;
  gravityValueEl.textContent = gravity.toFixed(2); jumpValueEl.textContent = jumpForce.toString();
  // show start screen (already visible)
}
startInitial();

/* ---------- resize ---------- */
window.addEventListener('resize', ()=>{ /* keep fixed canvas for simplicity */ });

</script>
</body>
</html>
